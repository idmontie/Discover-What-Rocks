<template name="meetupsAddForm">
  <div class="row">
    <div class="large-offset-1 large-10 columns">
      <h1 class="lead">Create a Meetup for "{{name}}"</h1>

      <form id="meetups_add_form">
        <label class="{{#if nameIsNotValid}}error{{/if}}">
          Name Your Meetup
          <input type="text" name="name" />
        </label>
        {{#if nameIsNotValid}}
          <small class="error">{{{nameErrorMessage}}}</small>
        {{/if}}

        <label class="{{#if dateIsNotValid}}error{{/if}}">
          When To Meet
          <input type="datetime" name="dateToMeet" />
        </label>
        {{#if dateIsNotValid}}
          <small class="error">{{{dateErrorMessage}}}</small>
        {{/if}}

        <label>
          Type of Meetup
          <select name="meetupType">
            {{#each placeTypes}}
              <option value="{{slug}}">{{readibleName}}</option>
            {{/each}}
          </select>
        </label>

        <label>
          Meetup Distance (<span id="meetup_slider">1</span> miles)
          <div id="meetup_slider_foundation" class="range-slider radius" data-slider data-options="display_selector: #meetup_slider; start: 0; end: 10; step: 0.5;">
            <span class="range-slider-handle" role="slider" tabindex="0"></span>
            <span class="range-slider-active-segment"></span>
            <input type="hidden" name="meetup_slider_distance" value="1">
          </div>
        </label>

        <input type="hidden" id="map_center" />
        <a href="#" class="button postfix" id="use_current_location"  {{geolocationEnabled}} >Use My Current Location</a>

        {{#if locationIsNotValid}}
          <small class="error">{{{locationErrorMessage}}}</small>
        {{/if}}
        <div id="map-canvas" class="map-canvas"></div>

        <button aria-label="submit form" tabindex="0" type="submit" class="button success large expand">Create Meetup</button>
      </form>
    </div>
  </div>
  
  <script>
    // TODO clicking in the circle should move the circle
    // TODO clicking on a location should move the circle
    // TODO get better starting coordinates
    var Coords = {
      latitude: 33, 
      longitude: -112
    }
    var scaleFactor = 1600;

    var _$ = this;
    _$.meetupCircle = false;
    _$.scale = 1 * scaleFactor;
    _$.previewMarkers = [];
    _$.infowindow = new google.maps.InfoWindow();

    /**
     * @see http://xdsoft.net/jqplugins/datetimepicker/
     */
    jQuery( function ( $ ) {
      $( document ).ready( function () {
        $( 'input[name="dateToMeet"]' ).datetimepicker( {
          mask: '____/__/__ __:__ __',
          format: 'Y/m/d h:i a',
          formatTime: 'h:i a'
        } );

        _$.map = new google.maps.Map( document.getElementById( 'map-canvas' ), {
          center: new google.maps.LatLng( Coords.latitude, Coords.longitude ),
          zoom: 13,
          zoomControl: true,
          scaleControl: true,
          scrollwheel: false,
          disableDoubleClickZoom: true
        } );

        // Add click listener
        google.maps.event.addListener( _$.map, 'click', function ( np ) {
          setCenter( np.latLng.lat(), np.latLng.lng() );
        } );
      } );
    });

    $( document ).foundation( {
      slider: {
        on_change: function () {
          // TODO throttle
          setScale( $( 'input[name="meetup_slider_distance"]' ).val() );
        }
      }
    } );

    // Initialize scale
    $( '#meetup_slider_foundation' ).foundation( 'slider', 'set_value', _$.scale / scaleFactor);

  </script>
</template>

<template name="meetups-update-form">
  <!-- TODO -->
</template>